MODULE ProjectBillStendex;

REQUIRE Project, BillPaymentStendex;

NAMESPACE Project;

newLegalEntityBill 'Добавить' (Project p) {
    NEWSESSION {
        NEW b = Bill {
            type(b) <- legalEntityType();
            project(b) <- p;
            SHOW billCustom OBJECTS b = b;
        }
    }
}

newIndividualBill 'Добавить' (Project p) {
    NEWSESSION {
        NEW b = Bill {
            type(b) <- individualType();
            project(b) <- p;
            SHOW billCustom OBJECTS b = b;
        }
    }
}

EXTEND FORM project
    OBJECTS bl 'Счета на оплату' = Bill BACKGROUND backgroundColor(bl)
    PROPERTIES(bl) READONLY number, date, items, nameProject, note, overNameRepresentative, amount, left, toPay, paidDone
    PROPERTIES(bl) READONLYIF readonly(p) 'Счет' = openFiles GRID
    PROPERTIES READONLYIF readonly(p) newLegalEntityBill(p) DRAW bl TOOLBAR
    PROPERTIES(bl) READONLYIF readonly(p) NEWSESSION editBillCustom, DELETE
    FILTERS legalEntity(bl), project(bl) = p

    OBJECTS bi 'Оплата freelance' = Bill BACKGROUND backgroundColor(bi)
    PROPERTIES(bi) READONLY number, date, items, nameProject, note, overNameRepresentative, amount, left, toPay, paidDone
    PROPERTIES(bi) READONLYIF readonly(p) 'Счет' = openFiles GRID
    PROPERTIES READONLYIF readonly(p) newIndividualBill(p) DRAW bi TOOLBAR
    PROPERTIES(bi) READONLYIF readonly(p) NEWSESSION editBillCustom, DELETE
    FILTERS individual(bi), project(bi) = p 
;

DESIGN project {
    details {
        NEW bills {
            caption = badged('Счета', countBills(p));
            MOVE BOX(bl);
            MOVE BOX(bi);
        }
    }
}